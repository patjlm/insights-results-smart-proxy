<!DOCTYPE html>
<!--
 Copyright 2022 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>handlers_v2.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>handlers_v2.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"><p>Copyright 2020, 2021 Red Hat, Inc</p>

<p>Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">server</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>handlers for API V2 endpoints</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;bytes&#34;</div><div class="operator"></div>
	<div class="literal">&#34;encoding/json&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;io/ioutil&#34;</div><div class="operator"></div>
	<div class="literal">&#34;net/http&#34;</div><div class="operator"></div>
	<div class="literal">&#34;net/url&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strings&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-content-service/groups&#34;</div><div class="operator"></div>
	<div class="ident">httputils</div> <div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/http&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/responses&#34;</div><div class="operator"></div>
	<div class="ident">utypes</div> <div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/types&#34;</div><div class="operator"></div>
	<div class="ident">ctypes</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-types&#34;</div><div class="operator"></div>

	<div class="ident">ira_server</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/server&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-results-smart-proxy/content&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-smart-proxy/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>OnlyImpacting flag to only return impacting recommendations on GET /rule/</p>
</td>
	<td class="code"><pre><code>	<div class="ident">OnlyImpacting</div> <div class="operator">=</div> <div class="ident">iota</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>IncludingImpacting flag to return all recommendations including impacting ones on GET /rule/</p>
</td>
	<td class="code"><pre><code>	<div class="ident">IncludingImpacting</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExcludingImpacting flag to return all recommendations excluding impacting ones on GET /rule/</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExcludingImpacting</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>OkMsg is in status field with HTTP 200 response</p>
</td>
	<td class="code"><pre><code>	<div class="ident">OkMsg</div>       <div class="operator">=</div> <div class="literal">&#34;ok&#34;</div><div class="operator"></div>
	<div class="ident">selectorStr</div> <div class="operator">=</div> <div class="literal">&#34;selector&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getContentCheckInternal retrieves static content for the given ruleID and if the rule is internal,
checks if user has permissions to access it.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getContentCheckInternal</div><div class="operator">(</div><div class="ident">ruleID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">ruleContent</div> <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleWithContent</div><div class="operator">,</div>
	<div class="ident">err</div> <div class="ident">error</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ruleContent</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetContentForRecommendation</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check for internal rule permissions</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">internal</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">IsRuleInternal</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">internal</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">checkInternalRulePermissions</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getRuleWithGroups retrieves static content for the given ruleID along with rule groups</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getRuleWithGroups</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
	<div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div>
	<div class="ident">ruleID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">ruleContent</div> <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleWithContent</div><div class="operator">,</div>
	<div class="ident">ruleGroups</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">groups</div><div class="operator">.</div><div class="ident">Group</div><div class="operator">,</div>
	<div class="ident">err</div> <div class="ident">error</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ruleContent</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getContentCheckInternal</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error retrieving rule content for rule ID %v&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve the latest groups configuration</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ruleGroups</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getGroupsConfig</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error retrieving rule groups&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getRecommendationContent retrieves the static content for the given ruleID tied
with groups info. rule ID is expected to be the composite rule ID (rule.module|ERROR_KEY)</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getRecommendationContent</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readCompositeRuleID</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error retrieving rule ID from request&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">ruleContent</div><div class="operator">,</div> <div class="ident">ruleGroups</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getRuleWithGroups</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error retrieving rule content and groups for rule ID %v&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">contentResponse</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RecommendationContent</div><div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>RuleID in rule.module|ERROR_KEY format</p>
</td>
	<td class="code"><pre><code>		<div class="ident">RuleSelector</div><div class="operator">:</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">Description</div><div class="operator">:</div>  <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Description</div><div class="operator">,</div>
		<div class="ident">Generic</div><div class="operator">:</div>      <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Generic</div><div class="operator">,</div>
		<div class="ident">Reason</div><div class="operator">:</div>       <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Reason</div><div class="operator">,</div>
		<div class="ident">Resolution</div><div class="operator">:</div>   <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Resolution</div><div class="operator">,</div>
		<div class="ident">MoreInfo</div><div class="operator">:</div>     <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">MoreInfo</div><div class="operator">,</div>
		<div class="ident">TotalRisk</div><div class="operator">:</div>    <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">TotalRisk</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">RiskOfChange</div><div class="operator">:</div> <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">RiskOfChange</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">Impact</div><div class="operator">:</div>       <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Impact</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">Likelihood</div><div class="operator">:</div>   <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Likelihood</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">PublishDate</div><div class="operator">:</div>  <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">PublishDate</div><div class="operator">,</div>
		<div class="ident">Tags</div><div class="operator">:</div>         <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Tags</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare data structure for building response</p>
</td>
	<td class="code"><pre><code>	<div class="ident">responseContent</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;status&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">OkMsg</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;groups&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">ruleGroups</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;content&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">contentResponse</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>send response to client</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseContent</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getRecommendationContent retrieves the static content for the given ruleID tied
with groups info. rule ID is expected to be the composite rule ID (rule.module|ERROR_KEY)</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getRecommendationContentWithUserData</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readOrgIDAndUserIDFromToken</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">orgIDTokenError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readCompositeRuleID</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error retrieving rule ID from request&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">ruleContent</div><div class="operator">,</div> <div class="ident">ruleGroups</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getRuleWithGroups</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;error retrieving rule content and groups for rule ID %v&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rating</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getRatingForRecommendation</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">switch</div> <div class="ident">err</div><div class="operator">.</div><div class="operator">(</div><div class="keyword">type</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">case</div> <div class="operator">*</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">ItemNotFoundError</div><div class="operator">:</div>
			<div class="keyword">break</div><div class="operator"></div>
		<div class="keyword">case</div> <div class="operator">*</div><div class="ident">url</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">:</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;aggregator is not responding&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">AggregatorServiceUnavailableError</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="keyword">default</div><div class="operator">:</div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">ruleModule</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleIDWithErrorKeyFromCompositeRuleID</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ignoring the response and the possible error.
We are just interested on know if the rule is system disabled or not</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">ackFound</div><div class="operator">,</div> <div class="ident">_</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readRuleDisableStatus</div><div class="operator">(</div>
		<div class="ident">ctypes</div><div class="operator">.</div><div class="ident">Component</div><div class="operator">(</div><div class="ident">ruleModule</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">errorKey</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fill in user rating and other DB stuff from aggregator</p>
</td>
	<td class="code"><pre><code>	<div class="ident">contentResponse</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RecommendationContentUserData</div><div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>RuleID in rule.module|ERROR_KEY format</p>
</td>
	<td class="code"><pre><code>		<div class="ident">RuleSelector</div><div class="operator">:</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">Description</div><div class="operator">:</div>  <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Description</div><div class="operator">,</div>
		<div class="ident">Generic</div><div class="operator">:</div>      <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Generic</div><div class="operator">,</div>
		<div class="ident">Reason</div><div class="operator">:</div>       <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Reason</div><div class="operator">,</div>
		<div class="ident">Resolution</div><div class="operator">:</div>   <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Resolution</div><div class="operator">,</div>
		<div class="ident">MoreInfo</div><div class="operator">:</div>     <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">MoreInfo</div><div class="operator">,</div>
		<div class="ident">TotalRisk</div><div class="operator">:</div>    <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">TotalRisk</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">RiskOfChange</div><div class="operator">:</div> <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">RiskOfChange</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">Impact</div><div class="operator">:</div>       <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Impact</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">Likelihood</div><div class="operator">:</div>   <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Likelihood</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">PublishDate</div><div class="operator">:</div>  <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">PublishDate</div><div class="operator">,</div>
		<div class="ident">Rating</div><div class="operator">:</div>       <div class="ident">rating</div><div class="operator">.</div><div class="ident">Rating</div><div class="operator">,</div>
		<div class="ident">AckedCount</div><div class="operator">:</div>   <div class="literal">0</div><div class="operator">,</div>
		<div class="ident">Tags</div><div class="operator">:</div>         <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Tags</div><div class="operator">,</div>
		<div class="ident">Disabled</div><div class="operator">:</div>     <div class="ident">ackFound</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare data structure for building response</p>
</td>
	<td class="code"><pre><code>	<div class="ident">responseContent</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;status&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">OkMsg</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;groups&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">ruleGroups</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;content&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">contentResponse</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>send response to client</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseContent</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">problemSendingResponseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getRecommendations retrieves all recommendations with a count of impacted clusters
By default returns only those recommendations that currently hit at least one cluster,
but it's possible to show all recommendations by passing a URL parameter <code>impacting</code></p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getRecommendations</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">recommendationList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RecommendationListView</div><div class="operator"></div>
	<div class="ident">tStart</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">userID</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">impactingFlag</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readParamsGetRecommendations</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>everything handled</p>
</td>
	<td class="code"><pre><code>		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;problem reading necessary params from request&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;getRecommendations start&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">activeClustersInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readClusterInfoForOrgID</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;problem reading cluster list for org&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">clusterIDList</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">GetClusterNames</div><div class="operator">(</div><div class="ident">activeClustersInfo</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">tStartImpacting</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">impactingRecommendations</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getImpactingRecommendations</div><div class="operator">(</div>
		<div class="ident">writer</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">clusterIDList</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>log cluster list in case of error even though message might be too large for Kibana/zerolog</p>
</td>
	<td class="code"><pre><code>		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;problem getting impacting recommendations from aggregator for cluster list: %v&#34;</div><div class="operator">,</div> <div class="ident">clusterIDList</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Uint32</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">uint32</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div>
		<div class="literal">&#34;getRecommendations get impacting recommendations from aggregator took %s&#34;</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Since</div><div class="operator">(</div><div class="ident">tStartImpacting</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>get a map of acknowledged rules</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ackedRulesMap</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getRuleAcksMap</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve user disabled rules for given list of active clusters</p>
</td>
	<td class="code"><pre><code>	<div class="ident">disabledClustersForRules</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getRuleDisabledClusters</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">clusterIDList</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;problem getting user disabled rules for list of clusters&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>server error has been handled already</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">recommendationList</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">getFilteredRecommendationsList</div><div class="operator">(</div>
		<div class="ident">activeClustersInfo</div><div class="operator">,</div> <div class="ident">impactingRecommendations</div><div class="operator">,</div> <div class="ident">impactingFlag</div><div class="operator">,</div> <div class="ident">ackedRulesMap</div><div class="operator">,</div> <div class="ident">disabledClustersForRules</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;problem getting recommendation content&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;number of final recommendations: %d&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">recommendationList</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">resp</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">resp</div><div class="operator">[</div><div class="literal">&#34;status&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">OkMsg</div><div class="operator"></div>
	<div class="ident">resp</div><div class="operator">[</div><div class="literal">&#34;recommendations&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">recommendationList</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Uint32</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">uint32</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div>
		<div class="literal">&#34;getRecommendations took %s&#34;</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Since</div><div class="operator">(</div><div class="ident">tStart</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">resp</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">problemSendingResponseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getRuleAcksMap</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">ackedRulesMap</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">bool</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ackedRulesMap</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">bool</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve rule acknowledgements (disable/enable for all clusters)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ackedRules</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readListOfAckedRules</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">ackedRulesError</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>server error has been handled already</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>put rule acks in a map so we only iterate over them once</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ackedRulesMap</div> <div class="operator">=</div> <div class="ident">generateRuleAckMap</div><div class="operator">(</div><div class="ident">ackedRules</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getRuleDisabledClusters</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
	<div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="ident">clusterList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">ruleDisabledClusters</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ruleDisabledClusters</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">listOfDisabledRules</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readListOfDisabledRulesForClusters</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">clusterList</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;error reading disabled rules from aggregator&#34;</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>server error has been handled already</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">disabledRule</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">listOfDisabledRules</div> <div class="operator">{</div>
		<div class="ident">compositeRuleID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">generateCompositeRuleIDFromDisabled</div><div class="operator">(</div><div class="ident">disabledRule</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;error generating composite rule ID&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">ruleDisabledClusters</div><div class="operator">[</div><div class="ident">compositeRuleID</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">ruleDisabledClusters</div><div class="operator">[</div><div class="ident">compositeRuleID</div><div class="operator">]</div><div class="operator">,</div> <div class="ident">disabledRule</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getClustersView retrieves all clusters for given organization, retrieves the impacting rules for each cluster
from aggregator and returns a list of clusters, total number of hitting rules and a count of impacting rules
by severity = total risk = critical, high, moderate, low</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getClustersView</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">tStart</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readOrgIDAndUserIDFromToken</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">orgIDTokenError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;getClustersView start&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">clusterRuleHits</div><div class="operator">,</div> <div class="ident">ackedRulesMap</div><div class="operator">,</div> <div class="ident">disabledRules</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getClusterListAndUserData</div><div class="operator">(</div>
		<div class="ident">writer</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">clusterViewResponse</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">matchClusterInfoAndUserData</div><div class="operator">(</div>
		<div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">clusterRuleHits</div><div class="operator">,</div> <div class="ident">ackedRulesMap</div><div class="operator">,</div> <div class="ident">disabledRules</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Uint32</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">uint32</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;getClustersView error generating cluster list response&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Uint32</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">uint32</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getClustersView final number %v&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">clusterViewResponse</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">resp</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">metaCount</div> <div class="operator">:=</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="ident">int</div><div class="operator">{</div>
		<div class="literal">&#34;count&#34;</div><div class="operator">:</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">clusterViewResponse</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">resp</div><div class="operator">[</div><div class="literal">&#34;status&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">OkMsg</div><div class="operator"></div>
	<div class="ident">resp</div><div class="operator">[</div><div class="literal">&#34;meta&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">metaCount</div><div class="operator"></div>
	<div class="ident">resp</div><div class="operator">[</div><div class="literal">&#34;data&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">clusterViewResponse</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Uint32</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">uint32</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getClustersView took %s&#34;</div><div class="operator">,</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Since</div><div class="operator">(</div><div class="ident">tStart</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">resp</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">problemSendingResponseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getSingleClusterInfo retrieves information about given cluster from AMS API, such as the user defined display name</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getSingleClusterInfo</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">amsClient</div> <div class="operator">==</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;AMS API connection is not initialized&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">AMSAPIUnavailableError</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">authToken</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

	<div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">ReadClusterName</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>error handled by function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">clusterInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">amsClient</div><div class="operator">.</div><div class="ident">GetSingleClusterInfoForOrganization</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;problem retrieving cluster info from AMS API&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieval failed, but error is nil</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">clusterInfo</div><div class="operator">.</div><div class="ident">ID</div> <div class="operator">==</div> <div class="literal">&#34;&#34;</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="operator">&amp;</div><div class="ident">utypes</div><div class="operator">.</div><div class="ident">ItemNotFoundError</div><div class="operator">{</div><div class="ident">ItemID</div><div class="operator">:</div> <div class="ident">clusterID</div><div class="operator">}</div><div class="operator"></div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;unexpected problem retrieving cluster info from AMS API&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">BuildOkResponseWithData</div><div class="operator">(</div><div class="literal">&#34;cluster&#34;</div><div class="operator">,</div> <div class="ident">clusterInfo</div><div class="operator">)</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">problemSendingResponseError</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>matchClusterInfoAndUserData matches data from AMS API, rule hits from aggregator + user data from aggregator
regarding disabled rules and calculates the numbers of hitting rules based on their severity (total risk)</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">matchClusterInfoAndUserData</div><div class="operator">(</div>
	<div class="ident">clusterInfoList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfo</div><div class="operator">,</div>
	<div class="ident">clusterRecommendationsMap</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterRecommendationMap</div><div class="operator">,</div>
	<div class="ident">systemWideDisabledRules</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">disabledRulesPerCluster</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div>
	<div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterListView</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clusterListView</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterListView</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">recommendationSeverities</div><div class="operator">,</div> <div class="ident">uniqueSeverities</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetExternalRuleSeverities</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">clusterListView</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">rulesManagedInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetExternalRulesManagedInfo</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">clusterListView</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>iterates over clusters and their hitting recommendations, accesses map to the get rule severity</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">i</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">clusterInfoList</div> <div class="operator">{</div>
		<div class="ident">clusterViewItem</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterListView</div><div class="operator">{</div>
			<div class="ident">ClusterID</div><div class="operator">:</div>       <div class="ident">clusterInfoList</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">.</div><div class="ident">ID</div><div class="operator">,</div>
			<div class="ident">ClusterName</div><div class="operator">:</div>     <div class="ident">clusterInfoList</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">.</div><div class="ident">DisplayName</div><div class="operator">,</div>
			<div class="ident">Managed</div><div class="operator">:</div>         <div class="ident">clusterInfoList</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">.</div><div class="ident">Managed</div><div class="operator">,</div>
			<div class="ident">HitsByTotalRisk</div><div class="operator">:</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">int</div><div class="operator">]</div><div class="ident">int</div><div class="operator">)</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>zero in unique severities to have constitent response</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">severity</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">uniqueSeverities</div> <div class="operator">{</div>
			<div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">HitsByTotalRisk</div><div class="operator">[</div><div class="ident">severity</div><div class="operator">]</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if there are any hitting recommendations</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">hittingRecommendations</div><div class="operator">,</div> <div class="ident">any</div> <div class="operator">:=</div> <div class="ident">clusterRecommendationsMap</div><div class="operator">[</div><div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">any</div> <div class="operator">{</div>
			<div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">LastCheckedAt</div> <div class="operator">=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">Timestamp</div><div class="operator">(</div>
				<div class="ident">hittingRecommendations</div><div class="operator">.</div><div class="ident">CreatedAt</div><div class="operator">.</div><div class="ident">UTC</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Format</div><div class="operator">(</div><div class="ident">time</div><div class="operator">.</div><div class="ident">RFC3339</div><div class="operator">)</div><div class="operator">,</div>
			<div class="operator">)</div><div class="operator"></div>
			<div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">Version</div> <div class="operator">=</div> <div class="ident">hittingRecommendations</div><div class="operator">.</div><div class="ident">Meta</div><div class="operator">.</div><div class="ident">Version</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>filter out acked and disabled rules</p>
</td>
	<td class="code"><pre><code>			<div class="ident">enabledOnlyRecommendations</div> <div class="operator">:=</div> <div class="ident">filterOutDisabledRules</div><div class="operator">(</div>
				<div class="ident">hittingRecommendations</div><div class="operator">.</div><div class="ident">Recommendations</div><div class="operator">,</div> <div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">,</div>
				<div class="ident">systemWideDisabledRules</div><div class="operator">,</div> <div class="ident">disabledRulesPerCluster</div><div class="operator">,</div>
			<div class="operator">)</div><div class="operator"></div>

			<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">ruleID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">enabledOnlyRecommendations</div> <div class="operator">{</div>
				<div class="keyword">if</div> <div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">Managed</div> <div class="operator">&amp;&amp;</div> <div class="operator">!</div><div class="ident">rulesManagedInfo</div><div class="operator">[</div><div class="ident">ruleID</div><div class="operator">]</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>cluster is managed, therefore must show only managed rules</p>
</td>
	<td class="code"><pre><code>					<div class="keyword">continue</div><div class="operator"></div>
				<div class="operator">}</div><div class="operator"></div>

				<div class="keyword">if</div> <div class="ident">ruleSeverity</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="ident">recommendationSeverities</div><div class="operator">[</div><div class="ident">ruleID</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">found</div> <div class="operator">{</div>
					<div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">HitsByTotalRisk</div><div class="operator">[</div><div class="ident">ruleSeverity</div><div class="operator">]</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
					<div class="ident">clusterViewItem</div><div class="operator">.</div><div class="ident">TotalHitCount</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
				<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rule content is missing for this rule; mimicking behaviour of other apps such as OCM = skip rule</p>
</td>
	<td class="code"><pre><code>					<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;rule content was not found for following rule ID. Skipping rule %v.&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
				<div class="operator">}</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">clusterListView</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">clusterListView</div><div class="operator">,</div> <div class="ident">clusterViewItem</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">clusterListView</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>filterOutDisabledRules filters out system-wide disabled rules (rule acknowledgement) and rules which had been
disabled on a single cluster basis.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">filterOutDisabledRules</div><div class="operator">(</div>
	<div class="ident">hittingRecommendations</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
	<div class="ident">clusterID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">systemWideDisabledRules</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">disabledRulesPerCluster</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">enabledOnlyRecommendations</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">hittingRuleID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">hittingRecommendations</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>no need to continue, rule has been acked</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">systemWideDisabledRules</div><div class="operator">[</div><div class="ident">hittingRuleID</div><div class="operator">]</div> <div class="operator">{</div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to find rule ID in list of disabled rules, if any</p>
</td>
	<td class="code"><pre><code>		<div class="ident">ruleDisabled</div> <div class="operator">:=</div> <div class="ident">false</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">disabledRulesList</div><div class="operator">,</div> <div class="ident">any</div> <div class="operator">:=</div> <div class="ident">disabledRulesPerCluster</div><div class="operator">[</div><div class="ident">clusterID</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">any</div> <div class="operator">{</div>
			<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">disabledRuleID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">disabledRulesList</div> <div class="operator">{</div>
				<div class="keyword">if</div> <div class="ident">disabledRuleID</div> <div class="operator">==</div> <div class="ident">hittingRuleID</div> <div class="operator">{</div>
					<div class="ident">ruleDisabled</div> <div class="operator">=</div> <div class="ident">true</div><div class="operator"></div>
				<div class="operator">}</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">ruleDisabled</div> <div class="operator">{</div>
			<div class="ident">enabledOnlyRecommendations</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">enabledOnlyRecommendations</div><div class="operator">,</div> <div class="ident">hittingRuleID</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Method getUserDisabledRulesPerCluster returns a map of cluster IDs with a list of disabled rules for each cluster</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getUserDisabledRulesPerCluster</div><div class="operator">(</div><div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">disabledRulesPerCluster</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">listOfDisabledRules</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readListOfClusterDisabledRules</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;error retrieving list of disabled rules&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">disabledRulesPerCluster</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">i</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">listOfDisabledRules</div> <div class="operator">{</div>
		<div class="ident">disabledRule</div> <div class="operator">:=</div> <div class="operator">&amp;</div><div class="ident">listOfDisabledRules</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator"></div>

		<div class="ident">compositeRuleID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">generateCompositeRuleIDFromDisabled</div><div class="operator">(</div><div class="operator">*</div><div class="ident">disabledRule</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">compositeRuleIDError</div><div class="operator">,</div> <div class="ident">disabledRule</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">disabledRule</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">ruleList</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="ident">disabledRulesPerCluster</div><div class="operator">[</div><div class="ident">disabledRule</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">found</div> <div class="operator">{</div>
			<div class="ident">disabledRulesPerCluster</div><div class="operator">[</div><div class="ident">disabledRule</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">ruleList</div><div class="operator">,</div> <div class="ident">compositeRuleID</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">disabledRulesPerCluster</div><div class="operator">[</div><div class="ident">disabledRule</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">]</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">{</div><div class="ident">compositeRuleID</div><div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">generateImpactingRuleIDList</div><div class="operator">(</div><div class="ident">impactingRecommendations</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">ruleIDList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">ruleIDList</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">impactingRecommendations</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">i</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">ruleID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">impactingRecommendations</div> <div class="operator">{</div>
		<div class="ident">ruleIDList</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">ruleID</div><div class="operator"></div>
		<div class="ident">i</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">excludeDisabledClusters</div><div class="operator">(</div>
	<div class="ident">impactingClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">disabledClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">filteredClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">impactingID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">impactingClusters</div> <div class="operator">{</div>
		<div class="ident">disabled</div> <div class="operator">:=</div> <div class="ident">false</div><div class="operator"></div>

		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">disabledID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">disabledClusters</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">impactingID</div> <div class="operator">==</div> <div class="ident">disabledID</div> <div class="operator">{</div>
				<div class="ident">disabled</div> <div class="operator">=</div> <div class="ident">true</div><div class="operator"></div>
				<div class="keyword">break</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">disabled</div> <div class="operator">{</div>
			<div class="ident">filteredClusters</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">filteredClusters</div><div class="operator">,</div> <div class="ident">impactingID</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">getFilteredRecommendationsList</div><div class="operator">(</div>
	<div class="ident">activeClustersInfo</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfo</div><div class="operator">,</div>
	<div class="ident">impactingRecommendations</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div><div class="operator">,</div>
	<div class="ident">impactingFlag</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ImpactingFlag</div><div class="operator">,</div>
	<div class="ident">ruleAcksMap</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">disabledClustersForRules</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">recommendationList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RecommendationListView</div><div class="operator">,</div>
	<div class="ident">err</div> <div class="ident">error</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clusterInfoMap</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfoArrayToMap</div><div class="operator">(</div><div class="ident">activeClustersInfo</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">recommendationList</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RecommendationListView</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">ruleIDList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">impactingFlag</div> <div class="operator">==</div> <div class="ident">OnlyImpacting</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve content only for impacting rules</p>
</td>
	<td class="code"><pre><code>		<div class="ident">ruleIDList</div> <div class="operator">=</div> <div class="ident">generateImpactingRuleIDList</div><div class="operator">(</div><div class="ident">impactingRecommendations</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve content for all external rules and decide whether exclude impacting in loop</p>
</td>
	<td class="code"><pre><code>		<div class="ident">ruleIDList</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetExternalRuleIDs</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;unable to retrieve external rule ids from content directory&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>iterate over rules and count impacted clusters, exluding user disabled ones</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">ruleID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">ruleIDList</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">impactedClustersCnt</div> <div class="ident">uint32</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rule has system-wide disabled status if found in the ack map,
but the user must be able to see the number of impacted clusters in the UI, so we need to go on</p>
</td>
	<td class="code"><pre><code>		<div class="ident">_</div><div class="operator">,</div> <div class="ident">ruleDisabled</div> <div class="operator">:=</div> <div class="ident">ruleAcksMap</div><div class="operator">[</div><div class="ident">ruleID</div><div class="operator">]</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>get list of impacting clusters</p>
</td>
	<td class="code"><pre><code>		<div class="ident">impactingClustersList</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="ident">impactingRecommendations</div><div class="operator">[</div><div class="ident">ruleID</div><div class="operator">]</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">found</div> <div class="operator">&amp;&amp;</div> <div class="ident">impactingFlag</div> <div class="operator">==</div> <div class="ident">ExcludingImpacting</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rule is impacting, but requester doesn't want them</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>remove any disabled clusters from the total count, if they're impacting</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">disabledClusters</div><div class="operator">,</div> <div class="ident">any</div> <div class="operator">:=</div> <div class="ident">disabledClustersForRules</div><div class="operator">[</div><div class="ident">ruleID</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">any</div> <div class="operator">{</div>
			<div class="ident">impactingClustersList</div> <div class="operator">=</div> <div class="ident">excludeDisabledClusters</div><div class="operator">(</div><div class="ident">impactingClustersList</div><div class="operator">,</div> <div class="ident">disabledClusters</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">ruleContent</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetContentForRecommendation</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">err</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="ident">err</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">content</div><div class="operator">.</div><div class="ident">RuleContentDirectoryTimeoutError</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
				<div class="keyword">return</div> <div class="ident">recommendationList</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>missing rule content, simply omit the rule as we can't display anything</p>
</td>
	<td class="code"><pre><code>			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;unable to get content for rule with id %v&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">OSDCustomer</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rule doesn't have osd_customer tag, so it doesn't apply to managed clusters</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">clusterID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">impactingClustersList</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>exclude non-managed clusters from the count</p>
</td>
	<td class="code"><pre><code>				<div class="keyword">if</div> <div class="operator">!</div><div class="ident">clusterInfoMap</div><div class="operator">[</div><div class="ident">clusterID</div><div class="operator">]</div><div class="operator">.</div><div class="ident">Managed</div> <div class="operator">{</div>
					<div class="ident">impactedClustersCnt</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
				<div class="operator">}</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rule has osd_customer tag and can be shown for all clusters</p>
</td>
	<td class="code"><pre><code>			<div class="ident">impactedClustersCnt</div> <div class="operator">=</div> <div class="ident">uint32</div><div class="operator">(</div><div class="ident">len</div><div class="operator">(</div><div class="ident">impactingClustersList</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">recommendationList</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">recommendationList</div><div class="operator">,</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RecommendationListView</div><div class="operator">{</div>
			<div class="ident">RuleID</div><div class="operator">:</div>              <div class="ident">ruleID</div><div class="operator">,</div>
			<div class="ident">Description</div><div class="operator">:</div>         <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Description</div><div class="operator">,</div>
			<div class="ident">Generic</div><div class="operator">:</div>             <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Generic</div><div class="operator">,</div>
			<div class="ident">PublishDate</div><div class="operator">:</div>         <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">PublishDate</div><div class="operator">,</div>
			<div class="ident">TotalRisk</div><div class="operator">:</div>           <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">TotalRisk</div><div class="operator">)</div><div class="operator">,</div>
			<div class="ident">Impact</div><div class="operator">:</div>              <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Impact</div><div class="operator">)</div><div class="operator">,</div>
			<div class="ident">Likelihood</div><div class="operator">:</div>          <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Likelihood</div><div class="operator">)</div><div class="operator">,</div>
			<div class="ident">Tags</div><div class="operator">:</div>                <div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">Tags</div><div class="operator">,</div>
			<div class="ident">Disabled</div><div class="operator">:</div>            <div class="ident">ruleDisabled</div><div class="operator">,</div>
			<div class="ident">RiskOfChange</div><div class="operator">:</div>        <div class="ident">uint8</div><div class="operator">(</div><div class="ident">ruleContent</div><div class="operator">.</div><div class="ident">RiskOfChange</div><div class="operator">)</div><div class="operator">,</div>
			<div class="ident">ImpactedClustersCnt</div><div class="operator">:</div> <div class="ident">impactedClustersCnt</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getImpactingRecommendations retrieves a list of recommendations from aggregator based on the list of clusters</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getImpactingRecommendations</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">userID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="ident">clusterList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="keyword">var</div> <div class="ident">aggregatorResponse</div> <div class="keyword">struct</div> <div class="operator">{</div>
		<div class="ident">Recommendations</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RecommendationImpactedClusters</div> <div class="literal">`json:&#34;recommendations&#34;`</div><div class="operator"></div>
		<div class="ident">Status</div>          <div class="ident">string</div>                                <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">RecommendationsListEndpoint</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">jsonMarshalled</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Marshal</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getImpactingRecommendations problem unmarshalling cluster list&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Post</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">,</div> <div class="ident">JSONContentType</div><div class="operator">,</div> <div class="ident">bytes</div><div class="operator">.</div><div class="ident">NewBuffer</div><div class="operator">(</div><div class="ident">jsonMarshalled</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getImpactingRecommendations problem getting response from aggregator&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">responseBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">ioutil</div><div class="operator">.</div><div class="ident">ReadAll</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getImpactingRecommendations problem reading response body&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseBytes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">problemSendingResponseError</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">responseBytes</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getImpactingRecommendations problem unmarshalling JSON response&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Recommendations</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getClustersAndRecommendations retrieves a list of recommendations from aggregator based on the list of clusters</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getClustersAndRecommendations</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">userID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="ident">clusterList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterRecommendationMap</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="keyword">var</div> <div class="ident">aggregatorResponse</div> <div class="keyword">struct</div> <div class="operator">{</div>
		<div class="ident">Clusters</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterRecommendationMap</div> <div class="literal">`json:&#34;clusters&#34;`</div><div class="operator"></div>
		<div class="ident">Status</div>   <div class="ident">string</div>                          <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">ClustersRecommendationsListEndpoint</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">jsonMarshalled</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Marshal</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;getClustersAndRecommendations problem unmarshalling cluster list&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Post</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">,</div> <div class="ident">JSONContentType</div><div class="operator">,</div> <div class="ident">bytes</div><div class="operator">.</div><div class="ident">NewBuffer</div><div class="operator">(</div><div class="ident">jsonMarshalled</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getClustersAndRecommendations problem getting response from aggregator&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="ident">err</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">url</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">AggregatorServiceUnavailableError</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">responseBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">ioutil</div><div class="operator">.</div><div class="ident">ReadAll</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getClustersAndRecommendations problem reading response body&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseBytes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="ident">problemSendingResponseError</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">responseBytes</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;getClustersAndRecommendations problem unmarshalling JSON response&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Clusters</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getContent retrieves all the static content tied with groups info</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getContentWithGroups</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Generate an array of RuleContent</p>
</td>
	<td class="code"><pre><code>	<div class="ident">allRules</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetAllContentV2</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">rules</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleContentV2</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">checkInternalRulePermissions</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">rule</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">allRules</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="operator">!</div><div class="ident">content</div><div class="operator">.</div><div class="ident">IsRuleInternal</div><div class="operator">(</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">(</div><div class="ident">rule</div><div class="operator">.</div><div class="ident">Plugin</div><div class="operator">.</div><div class="ident">PythonModule</div><div class="operator">)</div><div class="operator">)</div> <div class="operator">{</div>
				<div class="ident">rules</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">rules</div><div class="operator">,</div> <div class="ident">rule</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">rules</div> <div class="operator">=</div> <div class="ident">allRules</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>retrieve the latest groups configuration</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ruleGroups</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getGroupsConfig</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare data structure for building response</p>
</td>
	<td class="code"><pre><code>	<div class="ident">responseContent</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;status&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">OkMsg</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;groups&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">ruleGroups</div><div class="operator"></div>
	<div class="ident">responseContent</div><div class="operator">[</div><div class="literal">&#34;content&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">rules</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>send response to client</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseContent</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getImpactedClustersFromAggregator sends GET to aggregator with or without content
depending on the list of active clusters provided by the AMS client.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">getImpactedClustersFromAggregator</div><div class="operator">(</div>
	<div class="ident">url</div> <div class="ident">string</div><div class="operator">,</div>
	<div class="ident">activeClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">useAggregatorFallback</div> <div class="ident">bool</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="ident">resp</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Response</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">activeClusters</div><div class="operator">)</div> <div class="operator">&lt;</div> <div class="literal">1</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>		<div class="ident">resp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Get</div><div class="operator">(</div><div class="ident">url</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>generate JSON payload of the format &quot;clusters&quot;: []clusters</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">jsonBody</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator"></div>
	<div class="ident">jsonBody</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Marshal</div><div class="operator">(</div>
		<div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">{</div><div class="literal">&#34;clusters&#34;</div><div class="operator">:</div> <div class="ident">activeClusters</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Couldn&#39;t encode list of active clusters to valid JSON, aborting&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>GET method with list of active clusters in payload to avoid possible URL length problems</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">req</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator"></div>
	<div class="ident">req</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">NewRequest</div><div class="operator">(</div><div class="ident">http</div><div class="operator">.</div><div class="ident">MethodGet</div><div class="operator">,</div> <div class="ident">url</div><div class="operator">,</div> <div class="ident">bytes</div><div class="operator">.</div><div class="ident">NewBuffer</div><div class="operator">(</div><div class="ident">jsonBody</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">req</div><div class="operator">.</div><div class="ident">Header</div><div class="operator">.</div><div class="ident">Set</div><div class="operator">(</div><div class="ident">contentTypeHeader</div><div class="operator">,</div> <div class="ident">JSONContentType</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">client</div> <div class="operator">:=</div> <div class="operator">&amp;</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Client</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
	<div class="ident">resp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">client</div><div class="operator">.</div><div class="ident">Do</div><div class="operator">(</div><div class="ident">req</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getImpactedClusters retrieves a list of clusters affected by the given recommendation from aggregator</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getImpactedClusters</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
	<div class="ident">orgID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div>
	<div class="ident">userID</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div>
	<div class="ident">selector</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">,</div>
	<div class="ident">activeClustersInfo</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfo</div><div class="operator">,</div>
	<div class="ident">useAggregatorFallback</div> <div class="ident">bool</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div>
	<div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">,</div>
	<div class="ident">error</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">activeClusters</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">GetClusterNames</div><div class="operator">(</div><div class="ident">activeClustersInfo</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">activeClusters</div><div class="operator">)</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">&amp;&amp;</div> <div class="operator">!</div><div class="ident">useAggregatorFallback</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>empty list from AMS is valid</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">RuleClusterDetailEndpoint</div><div class="operator">,</div>
		<div class="ident">selector</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

	<div class="ident">aggregatorResp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">getImpactedClustersFromAggregator</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">,</div> <div class="ident">activeClusters</div><div class="operator">,</div> <div class="ident">useAggregatorFallback</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>if http.Get fails for whatever reason</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">==</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">response</div> <div class="keyword">struct</div> <div class="operator">{</div>
			<div class="ident">Clusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div> <div class="literal">`json:&#34;clusters&#34;`</div><div class="operator"></div>
			<div class="ident">Status</div>   <div class="ident">string</div>                       <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">NewDecoder</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Decode</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">response</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">response</div><div class="operator">.</div><div class="ident">Clusters</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getClustersDetailForRule retrieves all the clusters affected by the recommendation
By default returns only those recommendations that currently hit at least one cluster, but it's
possible to show all recommendations by passing a URL parameter <code>impacting</code></p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getClustersDetailForRule</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">useAggregatorFallback</div> <div class="ident">bool</div><div class="operator"></div>

	<div class="ident">selector</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">ReadRuleSelector</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readOrgIDAndUserIDFromToken</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">orgIDTokenError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">recommendation</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetContentForRecommendation</div><div class="operator">(</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">(</div><div class="ident">selector</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>The given rule selector does not exit</p>
</td>
	<td class="code"><pre><code>		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Get list of clusters for given organization</p>
</td>
	<td class="code"><pre><code>	<div class="ident">activeClustersInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readClusterInfoForOrgID</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Error retrieving cluster IDs from AMS API. Will retrieve cluster list from aggregator.&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">useAggregatorFallback</div> <div class="operator">=</div> <div class="ident">true</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>if the recommendation is not intended to be used with OpenShift Dedicated (&quot;managed&quot;) clusters, we must exclude them</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">recommendation</div><div class="operator">.</div><div class="ident">OSDCustomer</div> <div class="operator">{</div>
		<div class="ident">filteredClusters</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfo</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">cluster</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">activeClustersInfo</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>skipping managed clusters, because recommendation isn't managed</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">if</div> <div class="operator">!</div><div class="ident">cluster</div><div class="operator">.</div><div class="ident">Managed</div> <div class="operator">{</div>
				<div class="ident">filteredClusters</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">filteredClusters</div><div class="operator">,</div> <div class="ident">cluster</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">activeClustersInfo</div> <div class="operator">=</div> <div class="ident">filteredClusters</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>get the list of clusters affected by given rule from aggregator and</p>
</td>
	<td class="code"><pre><code>	<div class="ident">impactedClusters</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getImpactedClusters</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">selector</div><div class="operator">,</div> <div class="ident">activeClustersInfo</div><div class="operator">,</div> <div class="ident">useAggregatorFallback</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">selectorStr</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">selector</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Couldn&#39;t get impacted clusters for given rule selector&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">disabledClusters</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">getListOfDisabledClusters</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">selector</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">selectorStr</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">selector</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Couldn&#39;t retrieve disabled clusters for given rule selector&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">processClustersDetailResponse</div><div class="operator">(</div><div class="ident">impactedClusters</div><div class="operator">,</div> <div class="ident">disabledClusters</div><div class="operator">,</div> <div class="ident">activeClustersInfo</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="ident">orgIDTag</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">userIDTag</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">userID</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">selectorStr</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">selector</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Couldn&#39;t process response for clusters detail&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>getListOfDisabledClusters reads list of disabled clusters from aggregator</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getListOfDisabledClusters</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div> <div class="ident">ruleSelector</div> <div class="ident">ctypes</div><div class="operator">.</div><div class="ident">RuleSelector</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">DisabledClusterInfo</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">response</div> <div class="keyword">struct</div> <div class="operator">{</div>
		<div class="ident">Status</div>           <div class="ident">string</div>                       <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
		<div class="ident">DisabledClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">DisabledClusterInfo</div> <div class="literal">`json:&#34;clusters&#34;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rule selector has already been validated</p>
</td>
	<td class="code"><pre><code>	<div class="ident">splitRuleID</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Split</div><div class="operator">(</div><div class="ident">string</div><div class="operator">(</div><div class="ident">ruleSelector</div><div class="operator">)</div><div class="operator">,</div> <div class="literal">&#34;|&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>rules disabled using v1 enable/disable endpoints include '.report' in the module</p>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">ListOfDisabledClusters</div><div class="operator">,</div>
		<div class="ident">splitRuleID</div><div class="operator">[</div><div class="literal">0</div><div class="operator">]</div><div class="operator">&#43;</div><div class="ident">dotReport</div><div class="operator">,</div>
		<div class="ident">splitRuleID</div><div class="operator">[</div><div class="literal">1</div><div class="operator">]</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">resp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Get</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">resp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">&amp;&amp;</div> <div class="ident">resp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusNotFound</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;error reading disabled clusters from aggregator: %v&#34;</div><div class="operator">,</div> <div class="ident">resp</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">NewDecoder</div><div class="operator">(</div><div class="ident">resp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Decode</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">response</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">response</div><div class="operator">.</div><div class="ident">DisabledClusters</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>processClustersDetailResponse processes responses from aggregator and AMS API and sends a response</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">processClustersDetailResponse</div><div class="operator">(</div>
	<div class="ident">impactedClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">,</div>
	<div class="ident">disabledClusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">DisabledClusterInfo</div><div class="operator">,</div>
	<div class="ident">clusterInfo</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfo</div><div class="operator">,</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
<div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>

	<div class="ident">data</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClustersDetailData</div><div class="operator">{</div>
		<div class="ident">EnabledClusters</div><div class="operator">:</div>  <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">HittingClustersData</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator">,</div>
		<div class="ident">DisabledClusters</div><div class="operator">:</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">DisabledClusterInfo</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>disabledMap is used to filter out the impacted clusters</p>
</td>
	<td class="code"><pre><code>	<div class="ident">disabledMap</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="keyword">map</div><div class="operator">[</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">]</div><div class="ident">ctypes</div><div class="operator">.</div><div class="ident">DisabledClusterInfo</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">clusterInfoMap</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterInfoArrayToMap</div><div class="operator">(</div><div class="ident">clusterInfo</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>filter out inactive clusters from disabled; fill in display names</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">disabledC</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">disabledClusters</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>omit clusters that weren't retrieved from AMS API</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">cluster</div><div class="operator">,</div> <div class="ident">found</div> <div class="operator">:=</div> <div class="ident">clusterInfoMap</div><div class="operator">[</div><div class="ident">disabledC</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">found</div> <div class="operator">{</div>
			<div class="ident">disabledC</div><div class="operator">.</div><div class="ident">ClusterName</div> <div class="operator">=</div> <div class="ident">cluster</div><div class="operator">.</div><div class="ident">DisplayName</div><div class="operator"></div>
			<div class="ident">disabledMap</div><div class="operator">[</div><div class="ident">disabledC</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">disabledC</div><div class="operator"></div>
			<div class="ident">data</div><div class="operator">.</div><div class="ident">DisabledClusters</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">data</div><div class="operator">.</div><div class="ident">DisabledClusters</div><div class="operator">,</div> <div class="ident">disabledC</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">impactedC</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">impactedClusters</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>omit disabled clusters</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">if</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">disabled</div> <div class="operator">:=</div> <div class="ident">disabledMap</div><div class="operator">[</div><div class="ident">impactedC</div><div class="operator">.</div><div class="ident">Cluster</div><div class="operator">]</div><div class="operator">;</div> <div class="ident">disabled</div> <div class="operator">{</div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">impactedC</div><div class="operator">.</div><div class="ident">Name</div> <div class="operator">=</div> <div class="ident">clusterInfoMap</div><div class="operator">[</div><div class="ident">impactedC</div><div class="operator">.</div><div class="ident">Cluster</div><div class="operator">]</div><div class="operator">.</div><div class="ident">DisplayName</div><div class="operator"></div>
		<div class="ident">data</div><div class="operator">.</div><div class="ident">EnabledClusters</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">data</div><div class="operator">.</div><div class="ident">EnabledClusters</div><div class="operator">,</div> <div class="ident">impactedC</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">response</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClustersDetailResponse</div><div class="operator">{</div>
		<div class="ident">Status</div><div class="operator">:</div> <div class="ident">OkMsg</div><div class="operator">,</div>
		<div class="ident">Data</div><div class="operator">:</div>   <div class="ident">data</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">response</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
